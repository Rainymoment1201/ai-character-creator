# 🔘 按钮功能说明

## ✨ 按钮显示规则

按照你的要求，已实现以下规则：

### 规则 1：按钮显示位置
- ✅ 按钮显示在 **Agent 最后一条回复的对话框下方**
- ✅ 不是单独的区域，而是紧跟在对话后面

### 规则 2：按钮出现时机
- ✅ 当用户和 Agent 聊了 **3 条消息**后
- ✅ 对应的按钮会出现在 Agent 回复下方

### 规则 3：按钮类型和顺序

#### 按钮 1：🎨 帮我生图
- **出现条件**：用户选择先生图，聊了3轮后
- **功能**：根据历史聊天记录生成角色图像
- **点击后**：调用生图 API，生成角色外观

#### 按钮 2：📝 生成角色信息
- **出现条件**：
  - 用户选择先创建信息，聊了3轮后，或
  - 图像已生成，继续聊了3轮后
- **功能**：根据历史聊天记录生成角色信息
- **点击后**：生成包含9个字段的完整角色信息

#### 按钮 3：✅ 确认创建
- **出现条件**：图像和角色信息**都已生成**
- **功能**：结合所有信息一键创建角色
- **点击后**：最终创建完成，显示结果

---

## 📊 完整流程示例

### 流程 A：先生图 → 再创建信息

```
用户：我想先生成图像
Agent：太好了！你想创建什么类型的角色呢？

用户：可爱的猫娘
Agent：哇！你想要什么画风呢？

用户：二次元风格，粉色长发
Agent：完美！她的服装呢？

[对话3轮后，出现按钮]
━━━━━━━━━━━━━━━━━━━━━━━
| 🎨 帮我生图 |            |            |
━━━━━━━━━━━━━━━━━━━━━━━

点击"帮我生图" → 生成图像

Agent：图像生成好啦！现在来设定角色信息吧~

用户：她叫小樱
Agent：好听的名字！她是什么性格呢？

用户：活泼开朗
Agent：很棒！她的背景故事呢？

[又聊了3轮后，出现第二个按钮]
━━━━━━━━━━━━━━━━━━━━━━━
|              | 📝 生成角色信息 |            |
━━━━━━━━━━━━━━━━━━━━━━━

点击"生成角色信息" → 生成完整角色信息

[两个都完成后，出现第三个按钮]
━━━━━━━━━━━━━━━━━━━━━━━
|              |              | ✅ 确认创建 |
━━━━━━━━━━━━━━━━━━━━━━━

点击"确认创建" → 角色创建完成！🎉
```

### 流程 B：先创建信息 → 再生图

```
用户：我想先设定角色信息
Agent：好的！先给她起个名字吧~

用户：叫艾莉娅
Agent：艾莉娅，好听！她是什么性格呢？

用户：温柔善良的精灵
Agent：很棒！她的背景故事是？

[对话3轮后，出现按钮]
━━━━━━━━━━━━━━━━━━━━━━━
|              | 📝 生成角色信息 |            |
━━━━━━━━━━━━━━━━━━━━━━━

点击"生成角色信息" → 生成角色信息

Agent：角色信息创建完成！现在来生成图像吧~

用户：银色长发
Agent：好的！眼睛颜色呢？

用户：翠绿色
Agent：完美！服装风格呢？

[又聊了3轮后，出现第一个按钮]
━━━━━━━━━━━━━━━━━━━━━━━
| 🎨 帮我生图 |              |            |
━━━━━━━━━━━━━━━━━━━━━━━

点击"帮我生图" → 生成图像

[两个都完成后，出现第三个按钮]
━━━━━━━━━━━━━━━━━━━━━━━
|              |              | ✅ 确认创建 |
━━━━━━━━━━━━━━━━━━━━━━━

点击"确认创建" → 角色创建完成！🎉
```

---

## 🎯 按钮显示逻辑

### 代码实现

按钮显示在最后一条 AI 消息下方：

```python
# 遍历对话历史
for idx, msg in enumerate(conversation_history):
    if msg["role"] == "assistant":
        显示 AI 消息
        
        # 如果是最后一条 AI 消息
        if idx == len(conversation_history) - 1:
            显示按钮区域：
            - 如果 show_image_button = True → 显示"🎨 帮我生图"
            - 如果 show_profile_button = True → 显示"📝 生成角色信息"
            - 如果 show_confirm_button = True → 显示"✅ 确认创建"
```

### 按钮状态控制

```python
# 图像按钮
if 对话轮次 >= 3 and 用户选择先生图 and 图像未生成:
    show_image_button = True

# 角色信息按钮（图像优先流程）
if 图像已生成 and 继续对话轮次 >= 3 and 角色信息未生成:
    show_profile_button = True

# 角色信息按钮（信息优先流程）
if 对话轮次 >= 3 and 用户选择先信息 and 角色信息未生成:
    show_profile_button = True

# 图像按钮（信息优先流程）
if 角色信息已生成 and 继续对话轮次 >= 3 and 图像未生成:
    show_image_button = True

# 确认按钮
if 图像已生成 and 角色信息已生成:
    show_confirm_button = True
```

---

## 🔧 技术实现

### 按钮的唯一 key
使用消息索引作为 key，避免重复：
```python
st.button("🎨 帮我生图", key=f"btn_image_{idx}")
st.button("📝 生成角色信息", key=f"btn_profile_{idx}")
st.button("✅ 确认创建", key=f"btn_confirm_{idx}")
```

### 按钮布局
使用3列布局，均匀分布：
```python
cols = st.columns(3)
with cols[0]: 显示按钮1
with cols[1]: 显示按钮2
with cols[2]: 显示按钮3
```

---

## ✅ 功能确认

- ✅ 按钮显示在 Agent 回复对话框下方
- ✅ 聊了3条消息后出现对应按钮
- ✅ 点击按钮根据历史记录生成
- ✅ 两个按钮都点完后显示确认按钮
- ✅ 点击确认按钮一键创建角色

---

## 🎮 使用说明

### 1. 启动应用
```bash
python3 -m streamlit run agent.py
```

### 2. 开始对话
选择先生图还是先创建信息

### 3. 持续对话
和 Agent 聊3轮以上

### 4. 点击按钮
在 Agent 回复下方会出现对应按钮

### 5. 完成创建
两个按钮都点击后，点击"确认创建"

---

**按钮功能已完全按照你的要求实现！** 🎉

