# 🔘 按钮调试说明

## ✅ 已修复的问题

### 1. **按钮显示逻辑**
- ✅ 按钮现在会显示在最后一条 Agent 回复下方
- ✅ 移除了多余的 container 包裹

### 2. **生图提示词强化**
- ✅ 系统提示词强调必须生成纯英文
- ✅ 禁止使用中文
- ✅ 禁止长篇描述
- ✅ 只使用关键词格式

### 3. **调试信息**
- ✅ 侧边栏显示对话轮次
- ✅ 侧边栏显示按钮状态
- ✅ 侧边栏显示当前状态

---

## 🎯 按钮显示规则

### 生图按钮 🎨

**显示条件**（必须同时满足）：
1. ✅ 用户选择了"先生图"（state = IMAGE_FIRST_GUIDING）
2. ✅ 对话轮次 >= 3（turn_count >= 3）
3. ✅ 图像未生成（image_generated = False）

**或者**：
1. ✅ 用户选择了"先角色信息"
2. ✅ 角色信息已生成
3. ✅ 继续对话轮次 >= 3
4. ✅ 图像未生成

### 角色信息按钮 📝

**显示条件**（必须同时满足）：
1. ✅ 用户选择了"先角色信息"（state = PROFILE_FIRST_GUIDING）
2. ✅ 对话轮次 >= 3（turn_count >= 3）
3. ✅ 角色信息未生成（profile_generated = False）

**或者**：
1. ✅ 用户选择了"先生图"
2. ✅ 图像已生成
3. ✅ 继续对话轮次 >= 3
4. ✅ 角色信息未生成

### 确认按钮 ✅

**显示条件**（必须同时满足）：
1. ✅ 图像已生成（image_generated = True）
2. ✅ 角色信息已生成（profile_generated = True）

---

## 🔍 如何查看按钮状态

### 侧边栏信息

启动应用后，左侧侧边栏会显示：

```
📊 对话进度
总轮次: 3
选择：先生图

🔘 按钮状态
🎨 生图按钮：显示中 ✓
📝 角色信息按钮：未显示
✅ 确认按钮：未显示

当前状态
生图优先-引导中
```

### 查看步骤

1. **查看对话轮次**
   - 看侧边栏的"总轮次"数字
   - 必须 >= 3 才会显示按钮

2. **查看当前状态**
   - IMAGE_FIRST_GUIDING = 正在引导生图
   - PROFILE_FIRST_GUIDING = 正在引导角色信息
   - IMAGE_GENERATED_PROFILE_GUIDING = 图像已生成，引导角色信息
   - PROFILE_GENERATED_IMAGE_GUIDING = 角色信息已生成，引导生图

3. **查看按钮状态**
   - 🎨 生图按钮：显示中 ✓ = 按钮应该显示
   - 🎨 生图按钮：未显示 = 条件未满足

---

## 🧪 测试步骤

### 测试 1：先生图流程

```
步骤 1：启动应用
python3 -m streamlit run agent.py

步骤 2：输入第一条消息
你：我想先生成图像
[查看侧边栏]
- 总轮次: 1
- 选择：先生图
- 状态：生图优先-引导中
- 生图按钮：未显示（轮次不足）

步骤 3：输入第二条消息
你：可爱的猫娘
[查看侧边栏]
- 总轮次: 2
- 生图按钮：未显示（轮次不足）

步骤 4：输入第三条消息
你：二次元风格，粉色长发
[查看侧边栏]
- 总轮次: 3
- 生图按钮：显示中 ✓

步骤 5：查看对话区域
Agent 最后一条回复下方应该出现：
━━━━━━━━━━━━━━━━━━━━━━━
| 🎨 帮我生图 |              |              |
━━━━━━━━━━━━━━━━━━━━━━━

步骤 6：点击按钮
点击"帮我生图"
→ 生成英文提示词
→ 调用硅基流动 API
→ 显示生成的图像
```

### 测试 2：检查生图提示词

点击"帮我生图"后，会看到：

```
🔍 查看生成的提示词（展开）

masterpiece, best quality, 1girl, anime style, 
long pink hair, blue eyes, cat ears, white dress, 
gentle smile, standing
|||
lowres, bad anatomy, bad hands, text, error, 
missing fingers, extra digit, cropped, worst quality
```

**检查项**：
- ✅ 全部是英文
- ✅ 只有关键词，无长篇描述
- ✅ 使用逗号分隔
- ✅ 有 ||| 分隔正面和负面提示词

---

## ❌ 常见问题

### 问题 1：按钮不显示

**症状**：对话了很多轮，按钮还是不出现

**检查**：
1. 查看侧边栏"总轮次"是否 >= 3
2. 查看"当前状态"是否正确
3. 查看"按钮状态"显示什么

**可能原因**：
- 用户没有明确选择"先生图"或"先角色信息"
- 状态转换未正确触发

**解决方法**：
- 在第一条消息中明确说"我想先生图"或"我想先生成角色信息"
- 点击"🔄 重新开始"重置状态

### 问题 2：按钮显示但点击无反应

**症状**：按钮显示了，但点击后没有反应

**可能原因**：
- API 配置错误
- 信息提取失败

**解决方法**：
1. 查看终端错误信息
2. 检查 .env 配置
3. 查看侧边栏"已收集的信息"是否有数据

### 问题 3：生成的提示词是中文

**症状**：生图提示词包含中文

**解决方法**：
- 已在系统提示词中强调必须使用英文
- 降低 temperature 到 0.5
- 如果还有中文，可以手动编辑提示词

---

## 🔧 手动调试代码

如果还有问题，可以在代码中添加打印：

```python
# 在 update_button_visibility 函数中添加
def update_button_visibility():
    print(f"DEBUG: state={st.session_state.state}")
    print(f"DEBUG: turn_count={st.session_state.turn_count}")
    print(f"DEBUG: user_preference={st.session_state.user_preference}")
    print(f"DEBUG: image_generated={st.session_state.image_generated}")
    
    # 图像按钮：对话 3 轮后显示
    if (st.session_state.state == "IMAGE_FIRST_GUIDING" and 
        st.session_state.turn_count >= 3 and 
        not st.session_state.image_generated):
        st.session_state.show_image_button = True
        print("DEBUG: 显示生图按钮")
```

查看终端输出的调试信息。

---

## 📞 需要帮助？

如果按钮还是不显示，请提供：

1. **侧边栏截图**（显示状态和轮次）
2. **对话记录**（前3条消息）
3. **终端错误信息**（如果有）

---

**按钮功能已修复，生图提示词已强化为纯英文！** 🎉

现在重启应用测试：
```bash
python3 -m streamlit run agent.py
```

查看左侧侧边栏的状态信息，就能知道按钮为什么显示或不显示了！😊

